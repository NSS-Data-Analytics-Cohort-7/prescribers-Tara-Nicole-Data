/*Question 1a: Which prescriber had the highest total number of claims (totaled over all drugs)? Report the npi and the total number of claims.*/

SELECT p2.npi, p2.nppes_provider_first_name, p2.nppes_provider_last_org_name, SUM(p1.total_claim_count) AS claims
FROM prescription AS p1
LEFT JOIN prescriber AS p2
ON p1.npi = p2.npi
WHERE p1.total_claim_count IS NOT NULL 
GROUP BY p2.npi, p2.nppes_provider_first_name, p2.nppes_provider_last_org_name
ORDER BY claims DESC; 

--Question 1a Answer: 1881634483 - Bruce Pendley, Total Claims - 99707

/*Question 1b: Repeat the above, but this time report the nppes_provider_first_name, nppes_provider_last_org_name, specialty_description, and the total number of claims.*/

SELECT p2.npi, p2.nppes_provider_first_name, p2.nppes_provider_last_org_name, p2.specialty_description, SUM(p1.total_claim_count) AS claims
FROM prescription AS p1
LEFT JOIN prescriber AS p2
ON p1.npi = p2.npi
WHERE p1.total_claim_count IS NOT NULL 
GROUP BY p2.npi, p2.nppes_provider_first_name, p2.nppes_provider_last_org_name, p2.specialty_description
ORDER BY claims DESC;

--Question 1b Answer: 1881634483 - Bruce Pendley, Total Claims - 99707, Family Practice 

/*Question 2a: Which specialty had the most total number of claims (totaled over all drugs)?*/

SELECT p2.specialty_description, SUM(p1.total_claim_count) AS claims
FROM prescription AS p1
LEFT JOIN prescriber AS p2
ON p1.npi = p2.npi
WHERE p1.total_claim_count IS NOT NULL
GROUP BY p2.specialty_description
ORDER BY claims DESC; 

--Question 2a Answer: Family Practice - 9,752,347

/*Question 2b: Which specialty had the most total number of claims for opiods?*/

SELECT specialty_description, SUM (p2.total_claim_count) AS total_opioid_claims
FROM prescriber AS p1
LEFT JOIN prescription AS p2
ON p1.npi = p2.npi
LEFT JOIN drug AS d
ON p2.drug_name = d.drug_name
WHERE total_claim_count IS NOT NULL AND opioid_drug_flag = 'Y' OR long_acting_opioid_drug_flag = 'Y'
GROUP BY specialty_description
ORDER BY total_opioid_claims DESC; 

--Question 2b Answer: Nurse Practitioner 900,845

/*Question 2c: Are there any specialties that appear in the prescriber table that have no associated prescriptions in the prescription table?*/

SELECT p1.specialty_description, COUNT(p2.total_claim_count)
FROM prescriber AS p1
LEFT JOIN prescription AS p2
ON p1.npi = p2.npi
WHERE total_claim_count IS NULL
GROUP BY specialty_description; 

--Question 2c Answer: 92 rows of specialties
